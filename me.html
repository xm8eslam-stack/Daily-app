<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>التطبيق اليومي الشامل</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:20px; }
h1, h2 { text-align:center; }
.task { display:flex; justify-content:space-between; background:#fff; margin:8px 0; padding:10px; border-radius:5px; flex-wrap:wrap; transition: all 0.3s ease; border-right: 5px solid transparent; }

/* تحديد شكل المهمة المكتملة */
.completed { 
    text-decoration: line-through; 
    background: #d4ffd4 !important;
    opacity: 0.7;
}

/* تمييز المهمة الحالية */
.current {
    background: #fff3cd !important; /* لون أصفر خفيف للتمييز */
    border-right: 5px solid #ffc107; /* شريط جانبي أصفر */
    box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); /* ظل خفيف */
    font-weight: bold;
}

button { background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; margin-left:5px; }
button:hover { background:#45a049; }

/* ألوان الأزرار السفلية */
#saveBtn { background: #17a2b8; }
#saveBtn:hover { background: #138496; }
#resetBtn { background: #ffc107; color: #333; }
#resetBtn:hover { background: #e0a800; }

.study { background:#fff0b3; width:100%; }
.exercise { background:#cce5ff; width:100%; }
.meal { background:#ffd9b3; width:100%; }
.relax { background:#e6ccff; width:100%; }
.mental { background:#d1ffd6; width:100%; }
.suggestion { font-size:0.9em; color:#333; margin-top:3px; width:100%; }
#progress { text-align:center; margin:10px 0; font-size:1.2em; font-weight: bold; }
#notes { width:100%; height:60px; margin-top:10px; border-radius:5px; padding:5px; border: 1px solid #ccc; }
#history { margin-top:20px; }
#addTask { margin-top:15px; display:flex; flex-wrap:wrap; gap:5px; align-items: center; }
#addTask input, #addTask select { 
    flex:1; 
    padding:8px; 
    border-radius:3px; 
    border:1px solid #ccc; 
    min-width: 100px; 
}
#addBtn { 
    padding: 8px 15px;
    background: #007bff; 
}
#addBtn:hover {
    background: #0056b3;
}
#saveButtons {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
}
#saveButtons button {
    flex: 1;
    margin: 0 5px;
}
</style>
</head>
<body>

<h1>التطبيق اليومي الشامل</h1>
<div id="progress">إنجاز اليوم: 0%</div>

<div id="tasks">
  <div class="task exercise" data-time="06:30"><span>6:30 – 7:00: تمارين صباحية</span><span class="suggestion">تمدد، سكوات 10 مرات، مشي سريع 10 دقائق</span><button>تمت</button><button>تراجع</button></div>
  <div class="task meal" data-time="07:00"><span>7:00 – 7:30: إفطار صحي</span><span class="suggestion">بيض مسلوق + شوفان + فواكه أو زبادي مع مكسرات</span><button>تمت</button><button>تراجع</button></div>
  <div class="task study" data-time="07:30"><span>7:30 – 9:00: مذاكرة جلسة 1</span><span class="suggestion">تقنية Pomodoro: 25 دقيقة تركيز، 5 دقائق راحة</span><button>تمت</button><button>تراجع</button></div>
  <div class="task relax" data-time="09:00"><span>9:00 – 9:15: استراحة</span><span class="suggestion">تمدد، شرب ماء، إراحة العين</span><button>تمت</button><button>تراجع</button></div>
  <div class="task study" data-time="09:15"><span>9:15 – 11:00: مذاكرة جلسة 2</span><span class="suggestion">تقنية Pomodoro</span><button>تمت</button><button>تراجع</button></div>
  <div class="task meal" data-time="11:00"><span>11:00 – 11:30: وجبة خفيفة</span><span class="suggestion">فاكهة + مكسرات</span><button>تمت</button><button>تراجع</button></div>
  <div class="task study" data-time="11:30"><span>11:30 – 13:00: مذاكرة جلسة 3</span><span class="suggestion">تقنية Pomodoro</span><button>تمت</button><button>تراجع</button></div>
  <div class="task meal" data-time="13:00"><span>13:00 – 13:30: غداء</span><span class="suggestion">صدر دجاج + أرز بني + خضار</span><button>تمت</button><button>تراجع</button></div>
  <div class="task relax" data-time="13:30"><span>13:30 – 14:00: استراحة بعد الغداء</span><span class="suggestion">قيلولة قصيرة أو استرخاء</span><button>تمت</button><button>تراجع</button></div>
  <div class="task study" data-time="14:00"><span>14:00 – 16:00: مذاكرة جلسة 4</span><span class="suggestion">تقنية Pomodoro</span><button>تمت</button><button>تراجع</button></div>
  <div class="task mental" data-time="16:00"><span>16:00 – 16:30: نشاط ذهني</span><span class="suggestion">ألعاب ذهنية، قراءة كتاب قصير</span><button>تمت</button><button>تراجع</button></div>
  <div class="task exercise" data-time="16:30"><span>16:30 – 17:00: تمارين مسائية</span><span class="suggestion">تمدد، جري خفيف</span><button>تمت</button><button>تراجع</button></div>
  <div class="task meal" data-time="17:00"><span>17:00 – 17:30: وجبة خفيفة مسائية</span><span class="suggestion">زبادي + فواكه</span><button>تمت</button><button>تراجع</button></div>
  <div class="task relax" data-time="17:30"><span>17:30 – 18:00: استراحة</span><span class="suggestion">شرب ماء، استرخاء العين</span><button>تمت</button><button>تراجع</button></div>
  <div class="task study" data-time="18:00"><span>18:00 – 20:00: مذاكرة جلسة 5</span><span class="suggestion">تقنية Pomodoro</span><button>تمت</button><button>تراجع</button></div>
  <div class="task meal" data-time="20:00"><span>20:00 – 20:30: عشاء خفيف</span><span class="suggestion">سلطة + بروتين + خضار</span><button>تمت</button><button>تراجع</button></div>
</div>

<h2>إضافة مهمة جديدة</h2>
<div id="addTask">
<input type="text" id="taskText" placeholder="اسم المهمة">
<select id="taskType">
    <option value="" disabled selected>اختر النوع</option>
    <option value="study">مذاكرة (Study)</option>
    <option value="exercise">رياضة (Exercise)</option>
    <option value="meal">وجبة (Meal)</option>
    <option value="relax">استراحة (Relax)</option>
    <option value="mental">ذهني (Mental)</option>
</select>
<input type="text" id="taskSuggestion" placeholder="اقتراح / ملاحظة (اختياري)">
<input type="text" id="taskTime" placeholder="وقت المهمة (HH:MM)" pattern="\d{2}:\d{2}">
<button id="addBtn">أضف المهمة</button>
</div>

<h2>ملاحظات اليوم</h2>
<textarea id="notes" placeholder="اكتب ملاحظاتك أو شعورك اليوم هنا..."></textarea>
<div id="saveButtons">
    <button id="saveBtn">حفظ اليوم والبدء بيوم فارغ</button>
    <button id="resetBtn">إعادة تعيين اليوم الحالي</button>
</div>

<h2>سجل الأيام السابقة</h2>
<div id="history"></div>

<script>
// دالة التمييز الجديدة
function highlightCurrentTask() {
    const tasks = document.querySelectorAll('#tasks .task');
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes(); // الوقت الحالي بالدقائق

    let closestTask = null;
    let minTimeDiff = Infinity;

    // إزالة التمييز الحالي من جميع المهام أولاً
    tasks.forEach(task => task.classList.remove('current'));

    tasks.forEach(task => {
        const timeAttr = task.dataset.time;
        if (!timeAttr) return;

        const [hours, minutes] = timeAttr.split(':').map(Number);
        const taskTime = hours * 60 + minutes;

        // حساب الفرق بين وقت المهمة والوقت الحالي
        // نبحث عن أقرب مهمة (في الماضي أو الحاضر أو المستقبل القريب)
        const timeDiff = currentTime - taskTime;

        // إذا لم يتم إنجاز المهمة
        if (!task.classList.contains('completed')) {
            // المهمة التي بدأت للتو أو تبدأ قريباً جداً
            if (timeDiff >= -30 && timeDiff < 60) { // المهام التي كانت قبل 30 دقيقة أو القادمة خلال 60 دقيقة
                if (Math.abs(timeDiff) < Math.abs(minTimeDiff)) {
                    minTimeDiff = timeDiff;
                    closestTask = task;
                }
            }
        }
    });

    if (closestTask) {
        closestTask.classList.add('current');
    }
}


// دالة التحقق من صحة الوقت (HH:MM)
function isValidTime(time) {
    if (!time) return true;
    const timeRegex = /^([01]\d|2[0-3]):?([0-5]\d)$/;
    return timeRegex.test(time);
}

// دالة الفرز
function sortTasks() {
    const tasksContainer = document.getElementById('tasks');
    const tasks = Array.from(tasksContainer.children);

    tasks.sort((a, b) => {
        const timeA = a.dataset.time || '23:59';
        const timeB = b.dataset.time || '23:59';
        
        if (timeA < timeB) return -1;
        if (timeA > timeB) return 1;
        return 0;
    });

    tasks.forEach(task => tasksContainer.appendChild(task));
}

// دالة لتحديث شريط التقدم
function updateProgress(){
  const tasks=document.querySelectorAll('#tasks .task');
  const completed=document.querySelectorAll('#tasks .task.completed');
  const percent=tasks.length > 0 ? Math.round((completed.length/tasks.length)*100) : 0;
  document.getElementById('progress').innerText=`إنجاز اليوم: ${percent}%`;
  saveState(); 
  highlightCurrentTask(); // تحديث التمييز
}

// حفظ حالة الإنجاز المؤقتة
function saveState() {
    const tasks = document.querySelectorAll('#tasks .task');
    const state = [];
    tasks.forEach((t) => {
        state.push({
            html: t.outerHTML,
            completed: t.classList.contains('completed')
        });
    });
    localStorage.setItem('currentDayState', JSON.stringify(state));
}

// استعادة حالة الإنجاز عند تحميل الصفحة
function loadState() {
    const savedState = JSON.parse(localStorage.getItem('currentDayState'));
    if (!savedState) return;

    const tasksContainer = document.getElementById('tasks');
    tasksContainer.innerHTML = ''; 

    savedState.forEach(item => {
        const div = document.createElement('div');
        div.innerHTML = item.html;
        const taskElement = div.firstElementChild; 
        
        if (item.completed) {
            taskElement.classList.add('completed');
        } else {
             taskElement.classList.remove('completed');
        }
        
        tasksContainer.appendChild(taskElement);
    });
    sortTasks(); 
}

// معالج النقر لـ "تمت" و "تراجع"
document.getElementById('tasks').addEventListener('click', e=>{
  if(e.target.tagName==='BUTTON'){
    const task=e.target.parentElement;
    if(e.target.innerText==='تمت') {
        task.classList.add('completed');
    }
    else if(e.target.innerText==='تراجع') {
        task.classList.remove('completed');
    }
    updateProgress();
  }
});

// معالج النقر على زر "أضف المهمة"
document.getElementById('addBtn').addEventListener('click', ()=>{
  const text=document.getElementById('taskText').value.trim();
  const type=document.getElementById('taskType').value.trim(); 
  const suggestion=document.getElementById('taskSuggestion').value.trim();
  const time=document.getElementById('taskTime').value.trim();
  
  if(!text || !type){
      alert("الرجاء إدخال اسم المهمة واختيار النوع.");
      return;
  }
  
  if(time && !isValidTime(time)){
      alert("تنسيق الوقت غير صحيح. يرجى إدخال الوقت بصيغة HH:MM (مثال: 09:30).");
      return;
  }

  const div=document.createElement('div');
  div.className=`task ${type}`;
  if(time) div.dataset.time=time;
  div.innerHTML=`<span>${time ? time + ' – ' : ''}${text}</span><span class="suggestion">${suggestion}</span><button>تمت</button><button>تراجع</button>`;
  
  document.getElementById('tasks').appendChild(div);
  
  document.getElementById('taskText').value='';
  document.getElementById('taskType').value='';
  document.getElementById('taskSuggestion').value='';
  document.getElementById('taskTime').value='';
  
  sortTasks(); 
  updateProgress();
});

// وظيفة حفظ اليوم (تستخدمها الأزرار السفلية)
function saveDay(clearTasks) {
    const tasks=document.querySelectorAll('#tasks .task');
    const notes=document.getElementById('notes').value;
    const dayData=[];
    tasks.forEach(t=>{
        dayData.push({
            text:t.querySelector('span').innerText,
            type:t.classList[1],
            completed:t.classList.contains('completed'),
            suggestion:t.dataset.time||'', // تم تصحيح هذا السطر إذا كان يخص الوقت
            time:t.dataset.time||''
        });
    });

    const allDays=JSON.parse(localStorage.getItem('dailyHistory')||'[]');
    allDays.push({date:new Date().toLocaleDateString('ar-EG'),tasks:dayData,notes});
    localStorage.setItem('dailyHistory',JSON.stringify(allDays));
    
    localStorage.removeItem('currentDayState'); 
    loadHistory();
    document.getElementById('notes').value = '';
    
    if (clearTasks) {
        document.getElementById('tasks').innerHTML = '';
        alert('تم حفظ اليوم! تم إفراغ قائمة المهام للبدء بيوم جديد.');
    } else {
        document.querySelectorAll('#tasks .task').forEach(t => t.classList.remove('completed'));
        alert('تم حفظ اليوم! تم إعادة تعيين المهام للبدء بيوم جديد بنفس القائمة.');
    }
    updateProgress();
}

// معالج زر "حفظ اليوم والبدء بيوم فارغ"
document.getElementById('saveBtn').addEventListener('click', () => saveDay(true));

// معالج زر "إعادة تعيين اليوم الحالي"
document.getElementById('resetBtn').addEventListener('click', () => saveDay(false));

// دالة تحميل سجل الأيام السابقة
function loadHistory(){
  const historyDiv=document.getElementById('history');
  const allDays=JSON.parse(localStorage.getItem('dailyHistory')||'[]');
  historyDiv.innerHTML='';
  allDays.slice().reverse().forEach(day=>{ 
    const div=document.createElement('div');
    div.style.border='1px solid #ccc';
    div.style.padding='10px';
    div.style.marginBottom='10px';
    div.style.borderRadius='5px';
    
    const completedCount = day.tasks.filter(t => t.completed).length;
    const totalCount = day.tasks.length;
    const dayPercent = totalCount > 0 ? Math.round((completedCount/totalCount)*100) : 0;
    
    div.innerHTML=`<strong>التاريخ: ${day.date}</strong> (الإنجاز: ${dayPercent}%)<br>
                  ملاحظات: ${day.notes.substring(0, 100)}${day.notes.length > 100 ? '...' : ''}<br>
                  <details><summary>عرض تفاصيل المهام (${completedCount}/${totalCount})</summary>
                  <ul style="list-style: none; padding: 0;">${day.tasks.map(t=>`<li style="margin-top: 5px; font-size: 0.9em;">${t.completed?'✅':'⬜'} ${t.text}</li>`).join('')}</ul>
                  </details>`;
    historyDiv.appendChild(div);
  });
}

// عند تحميل الصفحة
window.onload=()=>{
  loadState(); 
  loadHistory();
  updateProgress();
  sortTasks();
  // يتم تحديث التمييز كل دقيقة
  setInterval(highlightCurrentTask, 60000); 
};
</script>

</body>
</html>
